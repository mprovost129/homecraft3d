{% load static %}

<nav class="navbar navbar-expand-lg navbar-dark bg-dark border-bottom mb-1">
  <div class="container-fluid">

    <a class="navbar-brand d-flex align-items-center me-4" href="{% url 'storefront:storefront_home' %}">
      <img src="{% static 'images/homecraft3d_navbar_tight.svg' %}"
           alt="Home Craft 3D Logo"
           style="height:70px;width:auto;max-width:260px;object-fit:contain;display:block;margin-right:10px;">
    </a>

    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
            aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div class="collapse navbar-collapse" id="navbarNav">

      <ul class="navbar-nav mx-auto mb-2 mb-lg-0">
        <li class="nav-item"><a class="nav-link" href="{% url 'storefront:storefront_home' %}">Storefront</a></li>
        <li class="nav-item"><a class="nav-link" href="{% url 'products:product_list' %}">All Products</a></li>
      </ul>

      <form class="d-flex me-2" method="get" action="{% url 'products:product_list' %}" role="search">
        <input class="form-control me-2" type="search" name="q" value="{{ request.GET.q|default:'' }}"
               placeholder="Search models, creators..." aria-label="Search">
        <button class="btn btn-outline-primary" type="submit"><i class="bi bi-search"></i></button>
      </form>

      <ul class="navbar-nav mb-2 mb-lg-0 align-items-center">

        {% if user.is_authenticated %}
          {# Dashboard button (single source of truth) #}
          <li class="nav-item me-2">
            {% if user.is_owner %}
              <a class="btn btn-primary" href="{% url 'accounts:owner_dashboard' %}">
                <i class="bi bi-speedometer2"></i> Owner Dashboard
              </a>
            {% elif user.is_seller %}
              <a class="btn btn-primary" href="{% url 'sellers:dashboard' %}">
                <i class="bi bi-speedometer2"></i> Seller Dashboard
              </a>
            {% else %}
              <a class="btn btn-primary" href="{% url 'accounts:profile' %}">
                <i class="bi bi-person-circle"></i> My Dashboard
              </a>
            {% endif %}
          </li>

          {# Notifications #}
          <li class="nav-item dropdown">
            <a class="nav-link position-relative" href="#" id="notifDropdown" role="button"
               data-bs-toggle="dropdown" aria-expanded="false" title="Notifications">
              <i class="bi bi-bell" style="font-size:1.25rem;"></i>
              {% if unread_notifications_count|default:0 > 0 %}
                <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">
                  {{ unread_notifications_count }}
                </span>
              {% endif %}
            </a>

            <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="notifDropdown"
                style="min-width:320px;max-width:400px;">
              <li class="dropdown-header">Notifications</li>

              {% for notif in top_notifications %}
                <li>
                  <a class="dropdown-item d-flex justify-content-between align-items-center {% if not notif.is_read %}fw-bold{% endif %}"
                     href="{% url 'accounts:notifications' %}">
                    <span>{{ notif.message|truncatechars:40 }}</span>
                    <small class="text-muted ms-2">{{ notif.created_at|date:"Y-m-d H:i" }}</small>
                  </a>
                </li>
              {% empty %}
                <li><span class="dropdown-item text-muted">No notifications</span></li>
              {% endfor %}

              <li><hr class="dropdown-divider"></li>
              <li><a class="dropdown-item text-center" href="{% url 'accounts:notifications' %}">View all notifications</a></li>
            </ul>
          </li>
        {% endif %}

        {# Cart #}
        <li class="nav-item">
          <a class="nav-link position-relative" href="{% url 'storefront:cart' %}" title="View Cart">
            <i class="bi bi-cart" style="font-size:1.25rem;"></i>
            {% if cart_item_count|default:0 > 0 %}
              <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger"
                    style="font-size:0.75em;">
                {{ cart_item_count }}
                <span class="visually-hidden">cart items</span>
              </span>
            {% endif %}
          </a>
        </li>

        {# Messages #}
        <li class="nav-item">
          <a class="nav-link" href="{% url 'messaging:inbox' %}">
            <i class="bi bi-chat-dots me-1"></i> Messages
          </a>
        </li>

        {% if user.is_authenticated %}
          {# Profile dropdown holds all role-specific links #}
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle d-flex align-items-center" href="#" id="profileDropdown"
               role="button" data-bs-toggle="dropdown" aria-expanded="false" title="Profile">
              {% if user.profile_picture %}
                <img src="{{ user.profile_picture.url }}" alt="Profile Picture" class="rounded-circle"
                     style="width:32px;height:32px;object-fit:cover;">
              {% else %}
                <i class="bi bi-person-circle" style="font-size:1.25rem;"></i>
              {% endif %}
            </a>

            <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="profileDropdown">
              <li><a class="dropdown-item" href="{% url 'accounts:profile' %}">Profile</a></li>
              <li><a class="dropdown-item" href="{% url 'accounts:settings' %}">Settings</a></li>

              {% if user.is_owner %}
                <li><hr class="dropdown-divider"></li>
                <li><a class="dropdown-item" href="{% url 'accounts:owner_dashboard' %}">Owner Dashboard</a></li>
                <li><a class="dropdown-item" href="{% url 'storefront:settings' %}">Site Settings</a></li>
              {% endif %}

              {% if user.is_seller or user.is_owner %}
                <li><a class="dropdown-item" href="{% url 'sellers:dashboard' %}">Seller Dashboard</a></li>
                <li><a class="dropdown-item" href="{% url 'sellers:manage_products' %}">Manage Products</a></li>
                <li><a class="dropdown-item" href="{% url 'sellers:product_analytics' %}">Analytics</a></li>
              {% endif %}

              {% if user.is_consumer and not user.is_seller and not user.is_owner %}
                <li><a class="dropdown-item" href="{% url 'products:wishlist' %}">Wishlist</a></li>
                <li><a class="dropdown-item" href="{% url 'orders:history' %}">Order History</a></li>
                <li><a class="dropdown-item" href="{% url 'accounts:become_seller' %}">Become a Seller</a></li>
              {% endif %}

              <li><hr class="dropdown-divider"></li>
              <li><a class="dropdown-item" href="{% url 'accounts:logout' %}">Logout</a></li>
            </ul>
          </li>
        {% else %}
          <li class="nav-item"><a class="nav-link" href="{% url 'accounts:login' %}">Login</a></li>
          <li class="nav-item"><a class="nav-link" href="{% url 'accounts:register' %}">Register</a></li>
        {% endif %}

      </ul>
    </div>
  </div>
</nav>
