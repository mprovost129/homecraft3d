{% extends 'base.html' %}
{% block title %}Your Cart | {{ STORE_NAME }}{% endblock %}

{% block content %}
<div class="container mt-4">
  <h1>Your Cart</h1>

  <form method="post" action="{% url 'update_cart' %}">
    {% csrf_token %}

    <table class="table align-middle">
      <thead>
        <tr>
          <th>Product</th>
          <th style="width:120px;">Quantity</th>
          <th style="width:120px;">Price</th>
          <th style="width:120px;">Subtotal</th>
          <th style="width:120px;"></th>
        </tr>
      </thead>

      <tbody>
        {% for item in cart_items %}
          <tr>
            <td>
              {% with m=item.product.media.first %}
                {% if m and m.image %}
                  <img src="{{ m.image.url }}"
                       alt="{{ item.product.name }}"
                       style="height:48px;width:48px;object-fit:cover;margin-right:8px;vertical-align:middle;">
                {% endif %}
              {% endwith %}

              {# Ideally replace with {% url 'products:detail' item.product.id %} #}
              <a href="/products/{{ item.product.id }}/">{{ item.product.name }}</a>
            </td>

            <td>
              <input type="number"
                     name="quantity_{{ item.product.id }}"
                     value="{{ item.quantity }}"
                     min="1"
                     class="form-control"
                     style="width:90px;">
            </td>

            <td>${{ item.product.price|floatformat:2 }}</td>
            <td>${{ item.subtotal|floatformat:2 }}</td>

            <td>
              <a href="{% url 'remove_from_cart' item.product.id %}" class="btn btn-sm btn-danger">
                Remove
              </a>
            </td>
          </tr>
        {% empty %}
          <tr><td colspan="5">Your cart is empty.</td></tr>
        {% endfor %}
      </tbody>
    </table>

    <div class="mb-3">
      <strong>Total: ${{ total|floatformat:2 }}</strong>
    </div>

    <div class="d-flex flex-wrap gap-2">
      <button type="submit" class="btn btn-primary">Update Cart</button>

      {% if cart_items %}
        <button id="checkout-button" type="button" class="btn btn-success">Proceed to Checkout</button>
        <a href="/" class="btn btn-outline-secondary">Continue Shopping</a>
      {% endif %}
    </div>
  </form>

  {% if cart_items %}
    <form method="post" action="{% url 'empty_cart' %}" class="mt-3">
      {% csrf_token %}
      <button type="submit" class="btn btn-danger">Empty Cart</button>
    </form>
  {% endif %}
</div>

<script src="https://js.stripe.com/v3/"></script>
<script>
  function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
    return null;
  }

  document.addEventListener('DOMContentLoaded', function() {
    const checkoutBtn = document.getElementById('checkout-button');
    if (!checkoutBtn) return;

    checkoutBtn.addEventListener('click', function() {
      const csrftoken = getCookie('csrftoken');

      fetch('/payments/checkout/', {
        method: 'POST',
        headers: {
          'X-CSRFToken': csrftoken,
          'Accept': 'application/json'
        }
      })
      .then(response => response.json())
      .then(data => {
        if (data.url) {
          window.location.href = data.url;
        } else {
          alert('Error: ' + (data.error || 'Could not start checkout.'));
        }
      })
      .catch(() => alert('Error: Could not start checkout.'));
    });
  });
</script>
{% endblock %}
