{% extends 'base.html' %}
{% load static %}
{% block title %}Products | 3D Print Marketplace{% endblock %}
{% block content %}
<h1>Products</h1>

<div class="row">
	<div class="col-md-3">
		<div class="card mb-4">
			<div class="card-header"><strong>Categories</strong></div>
			<div class="card-body p-2">
				<form method="get" id="category-sidebar-form">
					<ul class="list-unstyled mb-0" id="category-sidebar-tree">
						<li>
							<a href="?{% if query %}q={{ query|urlencode }}&{% endif %}{% if price_min %}price_min={{ price_min }}&{% endif %}{% if price_max %}price_max={{ price_max }}&{% endif %}{% if sort %}sort={{ sort }}&{% endif %}" class="fw-bold {% if not category_id %}text-primary{% endif %}">All</a>
						</li>
						{% for cat in categories %}
							{% if cat.level == 0 %}
								<li>
									{% with has_subcat=False %}
									<span class="category-toggle" data-target="cat-{{ cat.id }}" style="cursor:pointer;user-select:none;">
										{% for subcat in categories %}
											{% if subcat.parent and subcat.parent.id == cat.id %}
												{% with has_subcat=True %}{% endwith %}
											{% endif %}
										{% endfor %}
										{% if has_subcat %}+{% else %}&nbsp;&nbsp;{% endif %}
									</span>
									{% endwith %}
																		{% if cat.image %}
																			<img src="{{ cat.image.url }}" alt="{{ cat.name }}" style="height:24px;width:24px;object-fit:cover;margin-right:4px;vertical-align:middle;">
																		{% endif %}
																		<a href="?{% if query %}q={{ query|urlencode }}&{% endif %}category={{ cat.id }}{% if price_min %}&price_min={{ price_min }}{% endif %}{% if price_max %}&price_max={{ price_max }}{% endif %}{% if sort %}&sort={{ sort }}{% endif %}" class="{% if cat.id|stringformat:'s' == category_id %}text-primary fw-bold{% endif %}">{{ cat.name }}</a>
									<ul class="list-unstyled ms-3" id="cat-{{ cat.id }}" style="display:none;">
										{% for subcat in categories %}
											{% if subcat.parent and subcat.parent.id == cat.id %}
												<li>
													<a href="?{% if query %}q={{ query|urlencode }}&{% endif %}category={{ subcat.id }}{% if price_min %}&price_min={{ price_min }}{% endif %}{% if price_max %}&price_max={{ price_max }}{% endif %}{% if sort %}&sort={{ sort }}{% endif %}" class="{% if subcat.id|stringformat:'s' == category_id %}text-primary fw-bold{% endif %}">{{ subcat.name }}</a>
												</li>
											{% endif %}
										{% endfor %}
									</ul>
								</li>
							{% endif %}
						{% endfor %}
					</ul>
				</form>
			</div>
		</div>
		<form method="get" class="mb-4">
			<div class="mb-2">
				<label for="search" class="form-label">Search</label>
				<input type="text" class="form-control" id="search" name="q" value="{{ query }}" placeholder="Product name...">
			</div>
			<div class="mb-2">
				<label for="price_min" class="form-label">Min Price</label>
				<input type="number" step="0.01" class="form-control" id="price_min" name="price_min" value="{{ price_min }}">
			</div>
			<div class="mb-2">
				<label for="price_max" class="form-label">Max Price</label>
				<input type="number" step="0.01" class="form-control" id="price_max" name="price_max" value="{{ price_max }}">
			</div>
			<div class="mb-2">
				<label for="sort" class="form-label">Sort By</label>
				<select class="form-select" id="sort" name="sort">
					<option value="newest" {% if sort == 'newest' %}selected{% endif %}>Newest</option>
					<option value="price_asc" {% if sort == 'price_asc' %}selected{% endif %}>Price: Low to High</option>
					<option value="price_desc" {% if sort == 'price_desc' %}selected{% endif %}>Price: High to Low</option>
					<option value="name" {% if sort == 'name' %}selected{% endif %}>Name</option>
				</select>
			</div>
			<div class="mb-2">
				<label for="tags" class="form-label">Tags</label>
				<input type="text" class="form-control" id="tags" name="tags" value="{{ tags }}" placeholder="e.g. vase, dragon, toy">
			</div>
			<div class="mb-2">
				<label for="seller" class="form-label">Seller</label>
				<select class="form-select" id="seller" name="seller">
					<option value="">All Sellers</option>
					{% for s in sellers %}
						<option value="{{ s.id }}" {% if seller_id|stringformat:'s' == s.id|stringformat:'s' %}selected{% endif %}>{{ s.user.username }}</option>
					{% endfor %}
				</select>
			</div>
			<div class="mb-2">
				<label for="min_rating" class="form-label">Min Rating</label>
				<select class="form-select" id="min_rating" name="min_rating">
					<option value="">Any</option>
					{% for r in "12345" %}
						<option value="{{ r }}" {% if min_rating|stringformat:'s' == r|stringformat:'s' %}selected{% endif %}>{{ r }}+</option>
					{% endfor %}
				</select>
			</div>
			<button type="submit" class="btn btn-primary w-100">Filter</button>
		</form>
	</div>
	<div class="col-md-9">
		<div class="row row-cols-1 row-cols-md-3 g-4">
			{% for product in products %}
				<div class="col">
					<div class="card h-100">
						<div class="card-body">
							<div class="d-flex align-items-center gap-2 justify-content-between">
								<span class="d-flex align-items-center gap-2">
									{{ product.name }}
									{% if product.featured_manual %}
										<span class="badge bg-warning text-dark" title="Featured">★</span>
									{% endif %}
									{% if product.is_digital %}
										<span class="badge bg-info text-dark" title="Digital">Digital</span>
									{% endif %}
									{% if product.is_physical %}
										<span class="badge bg-success" title="Physical">Physical</span>
									{% endif %}
									{% for pid, avg in avg_ratings.items %}
										{% if pid == product.id %}
											<span class="ms-2" title="Average rating">
												<span class="text-warning" style="font-size:1.1em;">
													{% for i in "12345" %}
														{% with i_float=i|stringformat:'i' %}
															{% if avg|floatformat:1 >= i_float %}
																&#9733;
															{% elif avg|floatformat:1 >= i_float|add:"-0.5" %}
																<span style="position:relative;display:inline-block;width:1em;">
																	<span style="position:absolute;left:0;width:50%;overflow:hidden;">&#9733;</span>
																	<span style="color:#e4e5e9;">&#9733;</span>
																</span>
															{% else %}
																<span style="color:#e4e5e9;">&#9733;</span>
															{% endif %}
														{% endwith %}
													{% endfor %}
													<span class="ms-1 small">({{ avg|floatformat:1 }})</span>
												</span>
											</span>
										{% endif %}
									{% endfor %}
								</span>
								{% if user.is_authenticated %}
									{% if product.id in wishlist_product_ids %}
										<a href="{% url 'remove_from_wishlist' product.id %}" class="text-danger" title="Remove from wishlist"><span style="font-size:1.3em;">&#10084;</span></a>
									{% else %}
										<a href="{% url 'add_to_wishlist' product.id %}" class="text-muted" title="Add to wishlist"><span style="font-size:1.3em;">&#9825;</span></a>
									{% endif %}
								{% endif %}
							</div>
							<p class="card-text">{{ product.description|truncatewords:20 }}</p>
														<p class="card-text"><strong>Price:</strong> ${{ product.price }}</p>
														{% if product.is_physical %}
															<p class="card-text">
																<strong>Stock:</strong>
																{% if product.inventory == 0 %}
																	<span class="text-danger">Out of stock</span>
																{% else %}
																	{{ product.inventory|default:'N/A' }}
																{% endif %}
															</p>
														{% endif %}
							<a href="{% url 'product_detail' product.id %}" class="btn btn-outline-primary">View</a>
						</div>
					</div>
				</div>
			{% empty %}
				<div class="col">
					<div class="alert alert-info">No products found.</div>
				</div>
			{% endfor %}
		</div>
		{% if is_paginated %}
		<nav aria-label="Product pagination">
			<ul class="pagination justify-content-center mt-4">
				{% if page_obj.has_previous %}
					<li class="page-item">
						<a class="page-link" href="?{% if query %}q={{ query|urlencode }}&{% endif %}{% if category_id %}category={{ category_id }}&{% endif %}{% if price_min %}price_min={{ price_min }}&{% endif %}{% if price_max %}price_max={{ price_max }}&{% endif %}{% if sort %}sort={{ sort }}&{% endif %}page={{ page_obj.previous_page_number }}" aria-label="Previous">
							<span aria-hidden="true">&laquo;</span>
						</a>
					</li>
				{% else %}
					<li class="page-item disabled"><span class="page-link">&laquo;</span></li>
				{% endif %}
				{% for num in paginator.page_range %}
					{% if page_obj.number == num %}
						<li class="page-item active"><span class="page-link">{{ num }}</span></li>
					{% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
						<li class="page-item"><a class="page-link" href="?{% if query %}q={{ query|urlencode }}&{% endif %}{% if category_id %}category={{ category_id }}&{% endif %}{% if price_min %}price_min={{ price_min }}&{% endif %}{% if price_max %}price_max={{ price_max }}&{% endif %}{% if sort %}sort={{ sort }}&{% endif %}page={{ num }}">{{ num }}</a></li>
					{% endif %}
				{% endfor %}
				{% if page_obj.has_next %}
					<li class="page-item">
						<a class="page-link" href="?{% if query %}q={{ query|urlencode }}&{% endif %}{% if category_id %}category={{ category_id }}&{% endif %}{% if price_min %}price_min={{ price_min }}&{% endif %}{% if price_max %}price_max={{ price_max }}&{% endif %}{% if sort %}sort={{ sort }}&{% endif %}page={{ page_obj.next_page_number }}" aria-label="Next">
							<span aria-hidden="true">&raquo;</span>
						</a>
					</li>
				{% else %}
					<li class="page-item disabled"><span class="page-link">&raquo;</span></li>
				{% endif %}
			</ul>
		</nav>
		{% endif %}
	</div>
</div>
<script src="{% static 'products/category_sidebar.js' %}"></script>
<style>
	#category-sidebar-tree .category-toggle { display: inline-block; width: 1.5em; text-align: center; }
	#category-sidebar-tree ul { margin-bottom: 0; }
</style>


<div class="row row-cols-1 row-cols-md-3 g-4">
	{% for product in products %}
		<div class="col">
			<div class="card h-100 shadow border-0 product-card">
				{% if product.media.first.image %}
					<a href="{% url 'product_detail' product.id %}">
						<img src="{{ product.media.first.image.url }}" class="card-img-top product-img" alt="{{ product.name }}">
					</a>
				{% endif %}
				<div class="card-body d-flex flex-column">
					<div class="d-flex align-items-center gap-2 justify-content-between mb-2">
						<span class="d-flex align-items-center gap-2">
							<a href="{% url 'product_detail' product.id %}" class="text-decoration-none fw-bold">{{ product.name }}</a>
							{% if product.featured_manual %}
								<span class="badge bg-warning text-dark" title="Featured">★</span>
							{% endif %}
							{% if product.is_digital %}
								<span class="badge bg-info text-dark" title="Digital">Digital</span>
							{% endif %}
							{% if product.is_physical %}
								<span class="badge bg-success" title="Physical">Physical</span>
							{% endif %}
						</span>
						{% if user.is_authenticated %}
							{% if product.id in wishlist_product_ids %}
								<a href="{% url 'remove_from_wishlist' product.id %}" class="text-danger" title="Remove from wishlist"><span style="font-size:1.3em;">&#10084;</span></a>
							{% else %}
								<a href="{% url 'add_to_wishlist' product.id %}" class="text-muted" title="Add to wishlist"><span style="font-size:1.3em;">&#9825;</span></a>
							{% endif %}
						{% endif %}
					</div>
					<p class="card-text">{{ product.description|truncatewords:20 }}</p>
					<p class="card-text"><strong>Price:</strong> ${{ product.price }}</p>
					{% if product.is_physical %}
						<p class="card-text">
							<strong>Stock:</strong>
							{% if product.inventory == 0 %}
								<span class="text-danger">Out of stock</span>
							{% else %}
								{{ product.inventory|default:'N/A' }}
							{% endif %}
						</p>
					{% endif %}
					<div class="d-grid gap-2 mt-auto">
						<a href="{% url 'product_detail' product.id %}" class="btn btn-outline-primary">View Details</a>
						<button class="btn btn-primary btn-add-to-cart" data-product-id="{{ product.id }}">Add to Cart</button>
					</div>
				</div>
			</div>
		</div>
	{% empty %}
		<div class="col">
			<div class="alert alert-info">No products found.</div>
		</div>
	{% endfor %}
</div>

{% if is_paginated %}
<nav aria-label="Product pagination">
	<ul class="pagination justify-content-center mt-4">
		{% if page_obj.has_previous %}
			<li class="page-item">
				<a class="page-link" href="?{% if query %}q={{ query|urlencode }}&{% endif %}{% if category_id %}category={{ category_id }}&{% endif %}{% if price_min %}price_min={{ price_min }}&{% endif %}{% if price_max %}price_max={{ price_max }}&{% endif %}{% if sort %}sort={{ sort }}&{% endif %}page={{ page_obj.previous_page_number }}" aria-label="Previous">
					<span aria-hidden="true">&laquo;</span>
				</a>
			</li>
		{% else %}
			<li class="page-item disabled"><span class="page-link">&laquo;</span></li>
		{% endif %}
		{% for num in paginator.page_range %}
			{% if page_obj.number == num %}
				<li class="page-item active"><span class="page-link">{{ num }}</span></li>
			{% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
				<li class="page-item"><a class="page-link" href="?{% if query %}q={{ query|urlencode }}&{% endif %}{% if category_id %}category={{ category_id }}&{% endif %}{% if price_min %}price_min={{ price_min }}&{% endif %}{% if price_max %}price_max={{ price_max }}&{% endif %}{% if sort %}sort={{ sort }}&{% endif %}page={{ num }}">{{ num }}</a></li>
			{% endif %}
		{% endfor %}
		{% if page_obj.has_next %}
			<li class="page-item">
				<a class="page-link" href="?{% if query %}q={{ query|urlencode }}&{% endif %}{% if category_id %}category={{ category_id }}&{% endif %}{% if price_min %}price_min={{ price_min }}&{% endif %}{% if price_max %}price_max={{ price_max }}&{% endif %}{% if sort %}sort={{ sort }}&{% endif %}page={{ page_obj.next_page_number }}" aria-label="Next">
					<span aria-hidden="true">&raquo;</span>
				</a>
			</li>
		{% else %}
			<li class="page-item disabled"><span class="page-link">&raquo;</span></li>
		{% endif %}
	</ul>
</nav>
{% endif %}
{% endblock %}
{% block extra_js %}
<script src="{% static 'js/cart.js' %}"></script>
{% endblock %}
