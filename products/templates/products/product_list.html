{% extends 'base.html' %}
{% load static %}

{% block title %}Products | 3D Print Marketplace{% endblock %}

{% block content %}
<h1>Products</h1>

<div class="row">
  <div class="col-md-3">

    <div class="card mb-4">
      <div class="card-header"><strong>Categories</strong></div>
      <div class="card-body p-2">
        <ul class="list-unstyled mb-0" id="category-sidebar-tree">

          <li>
            <a href="{% url 'products:product_list' %}"
               class="fw-bold {% if not category_id %}text-primary{% endif %}">
              All
            </a>
          </li>

          {# Expect category_tree = [{id,name,image,children:[...]}] #}
          {% for cat in category_tree %}
            <li class="mt-1">
              <span class="category-toggle" data-target="cat-{{ cat.id }}" style="cursor:pointer;user-select:none;">
                {% if cat.children %}+{% else %}&nbsp;&nbsp;{% endif %}
              </span>

              {% if cat.image %}
                <img src="{{ cat.image.url }}" alt="{{ cat.name }}"
                     style="height:24px;width:24px;object-fit:cover;margin-right:4px;vertical-align:middle;">
              {% endif %}

              <a href="?category={{ cat.id }}{% if query %}&q={{ query|urlencode }}{% endif %}{% if price_min %}&price_min={{ price_min }}{% endif %}{% if price_max %}&price_max={{ price_max }}{% endif %}{% if sort %}&sort={{ sort }}{% endif %}"
                 class="{% if cat.id|stringformat:'s' == category_id %}text-primary fw-bold{% endif %}">
                {{ cat.name }}
              </a>

              {% if cat.children %}
                <ul class="list-unstyled ms-3" id="cat-{{ cat.id }}" style="display:none;">
                  {% for sub in cat.children %}
                    <li>
                      <a href="?category={{ sub.id }}{% if query %}&q={{ query|urlencode }}{% endif %}{% if price_min %}&price_min={{ price_min }}{% endif %}{% if price_max %}&price_max={{ price_max }}{% endif %}{% if sort %}&sort={{ sort }}{% endif %}"
                         class="{% if sub.id|stringformat:'s' == category_id %}text-primary fw-bold{% endif %}">
                        {{ sub.name }}
                      </a>
                    </li>
                  {% endfor %}
                </ul>
              {% endif %}
            </li>
          {% endfor %}

        </ul>
      </div>
    </div>

    <form method="get" class="mb-4">
      <div class="mb-2">
        <label for="search" class="form-label">Search</label>
        <input type="text" class="form-control" id="search" name="q" value="{{ query }}" placeholder="Product name...">
      </div>

      <div class="mb-2">
        <label for="price_min" class="form-label">Min Price</label>
        <input type="number" step="0.01" class="form-control" id="price_min" name="price_min" value="{{ price_min }}">
      </div>

      <div class="mb-2">
        <label for="price_max" class="form-label">Max Price</label>
        <input type="number" step="0.01" class="form-control" id="price_max" name="price_max" value="{{ price_max }}">
      </div>

      <div class="mb-2">
        <label for="sort" class="form-label">Sort By</label>
        <select class="form-select" id="sort" name="sort">
          <option value="newest" {% if sort == 'newest' %}selected{% endif %}>Newest</option>
          <option value="price_asc" {% if sort == 'price_asc' %}selected{% endif %}>Price: Low to High</option>
          <option value="price_desc" {% if sort == 'price_desc' %}selected{% endif %}>Price: High to Low</option>
          <option value="name" {% if sort == 'name' %}selected{% endif %}>Name</option>
        </select>
      </div>

      <div class="mb-2">
        <label for="tags" class="form-label">Tags</label>
        <input type="text" class="form-control" id="tags" name="tags" value="{{ tags }}" placeholder="e.g. vase, dragon, toy">
      </div>

      <div class="mb-2">
        <label for="seller" class="form-label">Seller</label>
        <select class="form-select" id="seller" name="seller">
          <option value="">All Sellers</option>
          {% for s in sellers %}
            <option value="{{ s.id }}" {% if seller_id|stringformat:'s' == s.id|stringformat:'s' %}selected{% endif %}>
              {{ s.user.username }}
            </option>
          {% endfor %}
        </select>
      </div>

      <div class="mb-2">
        <label for="min_rating" class="form-label">Min Rating</label>
        <select class="form-select" id="min_rating" name="min_rating">
          <option value="">Any</option>
          {% for r in "12345" %}
            <option value="{{ r }}" {% if min_rating|stringformat:'s' == r|stringformat:'s' %}selected{% endif %}>{{ r }}+</option>
          {% endfor %}
        </select>
      </div>

      {% if category_id %}
        <input type="hidden" name="category" value="{{ category_id }}">
      {% endif %}

      <button type="submit" class="btn btn-primary w-100">Filter</button>
    </form>

  </div>

  <div class="col-md-9">

    <div class="row row-cols-1 row-cols-md-3 g-4">
      {% for product in products %}
        <div class="col">
          <div class="card h-100 shadow border-0 product-card">

            {% with m=product.media.first %}
              {% if m and m.image %}
                <a href="{% url 'product_detail' product.id %}">
                  <img src="{{ m.image.url }}" class="card-img-top product-img" alt="{{ product.name }}">
                </a>
              {% endif %}
            {% endwith %}

            <div class="card-body d-flex flex-column">
              <div class="d-flex align-items-center justify-content-between mb-2">
                <div class="d-flex align-items-center gap-2">
                  <a href="{% url 'product_detail' product.id %}" class="text-decoration-none fw-bold">
                    {{ product.name }}
                  </a>

                  {% if product.featured_manual %}<span class="badge bg-warning text-dark">â˜…</span>{% endif %}
                  {% if product.is_digital %}<span class="badge bg-info text-dark">Digital</span>{% endif %}
                  {% if product.is_physical %}<span class="badge bg-success">Physical</span>{% endif %}
                </div>

                {% if user.is_authenticated %}
                  {% if product.id in wishlist_product_ids %}
                    <a href="{% url 'remove_from_wishlist' product.id %}" class="text-danger" title="Remove from wishlist">&#10084;</a>
                  {% else %}
                    <a href="{% url 'add_to_wishlist' product.id %}" class="text-muted" title="Add to wishlist">&#9825;</a>
                  {% endif %}
                {% endif %}
              </div>

              <p class="card-text">{{ product.description|truncatewords:20 }}</p>
              <p class="card-text"><strong>Price:</strong> ${{ product.price|floatformat:2 }}</p>

              {% if product.is_physical %}
                <p class="card-text">
                  <strong>Stock:</strong>
                  {% if product.inventory == 0 %}
                    <span class="text-danger">Out of stock</span>
                  {% else %}
                    {{ product.inventory|default:'N/A' }}
                  {% endif %}
                </p>
              {% endif %}

              <div class="d-grid gap-2 mt-auto">
                <a href="{% url 'product_detail' product.id %}" class="btn btn-outline-primary">View Details</a>
                <button class="btn btn-primary btn-add-to-cart" data-product-id="{{ product.id }}">Add to Cart</button>
              </div>
            </div>
          </div>
        </div>
      {% empty %}
        <div class="col">
          <div class="alert alert-info">No products found.</div>
        </div>
      {% endfor %}
    </div>

    {% if is_paginated %}
      <nav aria-label="Product pagination">
        <ul class="pagination justify-content-center mt-4">
          {% if page_obj.has_previous %}
            <li class="page-item">
              <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if query %}&q={{ query|urlencode }}{% endif %}{% if category_id %}&category={{ category_id }}{% endif %}{% if price_min %}&price_min={{ price_min }}{% endif %}{% if price_max %}&price_max={{ price_max }}{% endif %}{% if sort %}&sort={{ sort }}{% endif %}">
                &laquo;
              </a>
            </li>
          {% else %}
            <li class="page-item disabled"><span class="page-link">&laquo;</span></li>
          {% endif %}

          {% for num in paginator.page_range %}
            {% if page_obj.number == num %}
              <li class="page-item active"><span class="page-link">{{ num }}</span></li>
            {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
              <li class="page-item">
                <a class="page-link" href="?page={{ num }}{% if query %}&q={{ query|urlencode }}{% endif %}{% if category_id %}&category={{ category_id }}{% endif %}{% if price_min %}&price_min={{ price_min }}{% endif %}{% if price_max %}&price_max={{ price_max }}{% endif %}{% if sort %}&sort={{ sort }}{% endif %}">{{ num }}</a>
              </li>
            {% endif %}
          {% endfor %}

          {% if page_obj.has_next %}
            <li class="page-item">
              <a class="page-link" href="?page={{ page_obj.next_page_number }}{% if query %}&q={{ query|urlencode }}{% endif %}{% if category_id %}&category={{ category_id }}{% endif %}{% if price_min %}&price_min={{ price_min }}{% endif %}{% if price_max %}&price_max={{ price_max }}{% endif %}{% if sort %}&sort={{ sort }}{% endif %}">
                &raquo;
              </a>
            </li>
          {% else %}
            <li class="page-item disabled"><span class="page-link">&raquo;</span></li>
          {% endif %}
        </ul>
      </nav>
    {% endif %}

  </div>
</div>
{% endblock %}

{% block extra_js %}
  <script src="{% static 'products/category_sidebar.js' %}"></script>
  <script src="{% static 'js/cart.js' %}"></script>
{% endblock %}
